#!/usr/bin/env python

import json
import logging
import math
import os
import subprocess

MAX_SIZE_MB = 1950
LOG_FILE = "video_nvenc_processor.log"
VIDEO_CODEC = "h264_nvenc"

logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s [%(levelname)s] %(message)s",
    handlers=[logging.FileHandler(LOG_FILE), logging.StreamHandler()],
)


def get_video_info(file_path):
    """Используем JSON формат для надежного получения данных"""
    cmd = [
        "ffprobe",
        "-v",
        "error",
        "-show_entries",
        "format=duration,size",
        "-of",
        "json",
        file_path,
    ]
    result = subprocess.run(
        cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True
    )

    if result.returncode != 0:
        logging.error(f"Ошибка ffprobe для {file_path}: {result.stderr}")
        return None

    try:
        data = json.loads(result.stdout)
        return {
            "duration": float(data["format"]["duration"]),
            "size": int(data["format"]["size"]),
        }
    except (KeyError, ValueError, json.JSONDecodeError) as e:
        logging.error(f"Не удалось обработать метаданные {file_path}: {e}")
        return None


def process_videos():
    current_dir = os.getcwd()
    video_extensions = (".mp4", ".mkv", ".avi", ".mov", ".flv", ".wmv", ".webm", ".ts")

    files = [f for f in os.listdir(current_dir) if f.lower().endswith(video_extensions)]

    if not files:
        logging.info("Видеофайлы не найдены.")
        return

    for file in files:
        file_path = os.path.join(current_dir, file)
        base_name = os.path.splitext(file)[0]
        logging.info(f"Анализ: {file}")

        info = get_video_info(file_path)
        if not info:
            continue

        size_mb = info["size"] / (1024 * 1024)
        is_mp4 = file.lower().endswith(".mp4")

        work_file = file_path

        if not is_mp4:
            output_mp4 = f"{base_name}_converted.mp4"
            logging.info(f"Запуск NVENC для конвертации {file} в MP4...")
            conv_cmd = [
                "ffmpeg",
                "-hwaccel",
                "cuda",
                "-i",
                file_path,
                "-c:v",
                VIDEO_CODEC,
                "-preset",
                "p4",
                "-tune",
                "hq",
                "-c:a",
                "aac",
                "-b:a",
                "128k",
                output_mp4,
                "-y",
            ]
            try:
                subprocess.run(conv_cmd, check=True)
                work_file = output_mp4
                # Обновляем инфо после конвертации
                info = get_video_info(work_file)
                size_mb = info["size"] / (1024 * 1024)
            except subprocess.CalledProcessError as e:
                logging.error(f"Ошибка при конвертации {file}: {e}")
                continue

        # 2. Дробление (если файл > лимита)
        if size_mb > MAX_SIZE_MB:
            logging.info(f"Файл слишком большой ({size_mb:.2f} MB). Режем на части...")
            num_parts = math.ceil(size_mb / MAX_SIZE_MB)
            part_duration = info["duration"] / num_parts

            output_pattern = f"{base_name} - part %03d.mp4"
            split_cmd = [
                "ffmpeg",
                "-i",
                work_file,
                "-f",
                "segment",
                "-segment_time",
                str(part_duration),
                "-reset_timestamps",
                "1",
                "-c",
                "copy",
                output_pattern,
                "-y",
            ]
            try:
                subprocess.run(split_cmd, check=True)
                logging.info(f"Готово: {file} разделен на {num_parts} частей.")

                # Если мы создавали временный сконвертированный файл, удаляем его после резки
                if not is_mp4 and os.path.exists(work_file):
                    os.remove(work_file)
            except subprocess.CalledProcessError as e:
                logging.error(f"Ошибка при резке {file}: {e}")
        else:
            logging.info(f"Файл {file} в норме ({size_mb:.2f} MB).")
            # Если конвертировали, но резать не пришлось — оставляем финальный mp4
            if not is_mp4 and work_file != file_path:
                os.rename(work_file, f"{base_name}.mp4")


if __name__ == "__main__":
    logging.info("=== Запуск скрипта ===")
    try:
        process_videos()
    except Exception as e:
        logging.error(f"Критическая ошибка: {e}")
